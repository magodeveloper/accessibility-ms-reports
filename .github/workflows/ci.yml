# CI para .NET 9 + Docker + cobertura de cÃ³digo
name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  build-test:
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8.4
        env:
          MYSQL_ROOT_PASSWORD: rootpass
          MYSQL_DATABASE: reportsdb
          MYSQL_USER: devuser
          MYSQL_PASSWORD: devpass
        ports:
          - 3308:3306 # Expone el puerto 3306 del contenedor en el 3308 del host
        options: >-
          --health-cmd="mysqladmin ping -h localhost -prootpass" --health-interval=10s --health-timeout=5s --health-retries=10
    env:
      ConnectionStrings__Default: server=127.0.0.1;port=3308;database=reportsdb;user=devuser;password=devpass;TreatTinyAsBoolean=false
      ASPNETCORE_ENVIRONMENT: Development
    steps:
      - uses: actions/checkout@v4
      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"
      - name: Restore dependencies
        run: dotnet restore Reports.sln
      - name: Build
        run: dotnet build Reports.sln --no-restore --configuration Release
      - name: Wait for MySQL
        run: |
          for i in {1..30}; do
            if mysqladmin ping -h 127.0.0.1 -P3308 -uroot -prootpass --silent; then exit 0; fi
            sleep 2
          done
          exit 1
        shell: bash
      - name: Run tests with coverage
        run: dotnet test src/Reports.Tests/Reports.Tests.csproj --no-build --configuration Release --collect:"XPlat Code Coverage"
      - name: Report coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./src/Reports.Tests/TestResults/**/*.cobertura.xml
          fail_ci_if_error: true
          token: ${{ secrets.CODECOV_TOKEN }}
